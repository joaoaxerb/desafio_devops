name: CI Pipeline

on:
  push:
    branches: [ master, development ]
  pull_request:
    branches: [ master, development ]

jobs:
  lint:
    name: Lint e Validação de Código
    runs-on: ubuntu-latest

    steps:

      - name: Checkout Código
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Configurar Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      
      - name: Lint Python
        run: |
          cd app_python
          pip install flake8
          flake8 src/ --max-line-length=120 --ignore=E501 || true

      - name: Lint Go
        run: |
          cd app_go
          go fmt ./...
          go vet ./...

      - name: Validar Docker Compose
        run: docker compose config

  security:
    name: Segurança (SAST & SCA)
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: Checkout Código
        uses: actions/checkout@v4
      
      - name: Análise CodeQL (SAST)
        uses: github/codeql-action/init@v3
        with:
          languages: python, go
      
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3
      
      - name: Executar Análise CodeQL
        uses: github/codeql-action/analyze@v3
      
      - name: Verificação de Dependências Python
        run: |
          pip install safety
          cd app_python
          safety check --json || true
      
      - name: Verificação de Dependências Go
        run: |
          cd app_go
          go list -json -m all | docker run --rm -i sonatype/nancy:latest sleuth || true
      
      - name: Trivy - Docker Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  build-push:
    name: Build & Push Imagens Docker
    runs-on: ubuntu-latest
    needs: security
    permissions:
      contents: read
      packages: write
      security-events: write
      actions: read
    
    steps:
      - name: Checkout Código
        uses: actions/checkout@v4
      
      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login no GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extrair metadados
        id: meta
        run: |
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      
      - name: Build e Push - App Python
        uses: docker/build-push-action@v5
        with:
          context: ./app_python
          file: ./app_python/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/app-python:latest
            ghcr.io/${{ github.repository_owner }}/app-python:${{ steps.meta.outputs.sha_short }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build e Push - App Go
        uses: docker/build-push-action@v5
        with:
          context: ./app_go
          file: ./app_go/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/app-go:latest
            ghcr.io/${{ github.repository_owner }}/app-go:${{ steps.meta.outputs.sha_short }}
          cache-from: type=gha
          cache-to: type=gha,mode=max